<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Reconocimiento de Gestos</title>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 flex justify-center items-center h-screen text-white overflow-hidden">

  <!-- Video y Canvas -->
  <video id="input_video" autoplay playsinline class="absolute w-[1280px] h-[720px] rounded-xl object-cover"></video>
  <canvas id="output_canvas" class="absolute w-[1280px] h-[720px] rounded-xl object-cover"></canvas>

  <!-- Panel superior -->
  <div class="absolute top-5 left-5 bg-gray-800/90 p-4 rounded-xl shadow-lg w-72">
    <div class="flex justify-between items-center mb-2">
      <span>⏱️ Estado:</span>
      <span id="estado" class="font-semibold">Detectando...</span>
    </div>
    <div class="w-full h-2 bg-gray-700 rounded-full overflow-hidden mb-2">
      <div id="barra" class="h-full bg-cyan-400 transition-all duration-150" style="width:0%"></div>
    </div>
    <div class="flex justify-between items-center">
      <span>🕒 Temporizador:</span>
      <span id="timerValue" class="font-semibold">0.0 s</span>
    </div>
  </div>

  <!-- Chat lateral -->
  <div class="absolute right-5 top-1/2 transform -translate-y-1/2 w-80 h-96 bg-gray-800/90 p-4 rounded-xl shadow-lg overflow-y-auto">
    <h3 class="text-lg font-bold mb-2">🪞 Chat de Interpretación</h3>
    <div id="chat" class="text-sm space-y-1 overflow-y-auto h-80"></div>
  </div>

  <!-- Controles -->
  <div class="absolute bottom-5 flex space-x-6 justify-center w-full">
    <button id="btnCam" class="flex items-center justify-center w-20 h-20 bg-cyan-600 hover:bg-cyan-500 active:bg-cyan-700 text-white rounded-2xl shadow-xl transition transform hover:scale-110">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="currentColor" viewBox="0 0 24 24">
        <path d="M4 5a2 2 0 00-2 2v10a2 2 0 002 2h16a2 2 0 002-2V7a2 2 0 00-2-2h-4.586l-1.707-1.707A1 1 0 0014.586 3H9.414a1 1 0 00-.707.293L7 5H4zM12 9a4 4 0 110 8 4 4 0 010-8z"/>
      </svg>
    </button>
    <button id="btnPause" class="flex items-center justify-center w-20 h-20 bg-yellow-500 hover:bg-yellow-400 active:bg-yellow-600 text-white rounded-2xl shadow-xl transition transform hover:scale-110">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="currentColor" viewBox="0 0 24 24">
        <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
      </svg>
    </button>
    <button id="btnReset" class="flex items-center justify-center w-20 h-20 bg-indigo-600 hover:bg-indigo-500 active:bg-indigo-700 text-white rounded-2xl shadow-xl transition transform hover:scale-110">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="currentColor" viewBox="0 0 24 24">
        <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6h-2c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/>
      </svg>
    </button>
    <button id="btnStop" class="flex items-center justify-center w-20 h-20 bg-red-600 hover:bg-red-500 active:bg-red-700 text-white rounded-2xl shadow-xl transition transform hover:scale-110">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="currentColor" viewBox="0 0 24 24">
        <path d="M6 6h12v12H6z"/>
      </svg>
    </button>
  </div>

<script>
const CONFIG = {
  RES_W: 1280,
  RES_H: 720,
  PAUSA_LETRA: 1.5,
  PAUSA_PALABRA: 3.0,
  PAUSA_ORACION: 3.5,
  PAUSA_TEMPORIZADOR: 5.0,
  CONF_THRESH: 0.75,
  BUFFER_SIZE: 7,
  MIN_CONFIDENCE: 0.75,
  API_INTERVAL: 250,
  MIN_STABLE: 5
};

const video = document.getElementById('input_video');
const canvas = document.getElementById('output_canvas');
const ctx = canvas.getContext('2d');
const estado = document.getElementById('estado');
const barra = document.getElementById('barra');
const timerValue = document.getElementById('timerValue');
const chat = document.getElementById('chat');

let lastGestureTime = Date.now();
let lastDetected = false;
let currentTimer = 0;
let cameraOn = true;
let paused = false;
let cameraInstance = null;
let bufferLetras = [];
let ultimaLetra = null;
let lastApiCall = 0;
let apiInProgress = false;

// ======================
// Normalizar landmarks
// ======================
function normalizeLandmarksJS(landmarks) {
  const pts = landmarks.map(p => [p.x, p.y, p.z]);
  const wrist = pts[0];
  for(let i=0;i<pts.length;i++){
    pts[i][0]-=wrist[0];
    pts[i][1]-=wrist[1];
  }
  const refVec = pts[9];
  const ref = Math.sqrt(refVec[0]**2 + refVec[1]**2);
  const scale = ref>1e-6?ref:1.0;
  for(let i=0;i<pts.length;i++){
    pts[i][0]/=scale;
    pts[i][1]/=scale;
  }
  return pts;
}

// ======================
// Llamada API
// ======================
async function sendLandmarksToAPI(normalized){
  try{
    const res = await fetch("http://127.0.0.1:8000/predict",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({landmarks:normalized})
    });
    const data = await res.json();
    if(data.letter && data.confidence >= CONFIG.MIN_CONFIDENCE){
      bufferLetras.push(data.letter);
      if(bufferLetras.length > CONFIG.BUFFER_SIZE) bufferLetras.shift();

      const counts = {};
      bufferLetras.forEach(l=>counts[l]=(counts[l]||0)+1);
      const mostFrequent = Object.keys(counts).reduce((a,b)=>counts[a]>counts[b]?a:b);

      if(counts[mostFrequent]>=CONFIG.MIN_STABLE && mostFrequent!==ultimaLetra){
        ultimaLetra = mostFrequent;
        chat.innerHTML += `<div>🔤 Letra detectada: ${mostFrequent} (Conf: ${Math.round(data.confidence*100)}%)</div>`;
        chat.scrollTop = chat.scrollHeight;
      }
    }
  }catch(err){ console.error("Error API:",err);}
}

// ======================
// MediaPipe Hands
// ======================
const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
hands.setOptions({
  maxNumHands:1,
  modelComplexity:1,
  minDetectionConfidence:CONFIG.CONF_THRESH,
  minTrackingConfidence:CONFIG.CONF_THRESH
});
hands.onResults(onResults);

// ======================
// Función onResults optimizada
// ======================
function onResults(results){
  if(paused) return;
  ctx.save();
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // 💡 Dibuja en espejo solo a nivel visual
  ctx.translate(canvas.width, 0);
  ctx.scale(-1, 1);
  ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

  const now = Date.now();

  if(results.multiHandLandmarks && results.multiHandLandmarks.length > 0){
    const landmarks = results.multiHandLandmarks[0];
    drawConnectors(ctx, landmarks, HAND_CONNECTIONS, {color:'#00FF00', lineWidth:3});
    drawLandmarks(ctx, landmarks, {color:'#FF0000', lineWidth:3, radius:5});
    lastGestureTime = now; lastDetected = true; currentTimer = 0;
    estado.textContent = '✋ Mano detectada';

    if(now - lastApiCall > CONFIG.API_INTERVAL && !apiInProgress){
      apiInProgress = true;
      lastApiCall = now;
      const normalized = normalizeLandmarksJS(landmarks);
      sendLandmarksToAPI(normalized).finally(()=>apiInProgress=false);
    }

  } else if(lastDetected){
    currentTimer = (now - lastGestureTime) / 1000;
    timerValue.textContent = currentTimer.toFixed(1);
    if(currentTimer > CONFIG.PAUSA_TEMPORIZADOR){
      estado.textContent = '✅ Enviando oración';
      chat.innerHTML += `<div>📝 Oración completada.</div>`;
      lastDetected = false;
    } else if(currentTimer > CONFIG.PAUSA_ORACION){ estado.textContent = '🗣️ Fin de oración'; }
    else if(currentTimer > CONFIG.PAUSA_PALABRA){ estado.textContent = '💬 Fin de palabra'; }
    else if(currentTimer > CONFIG.PAUSA_LETRA){ estado.textContent = '🔤 Fin de letra'; }
    else { estado.textContent = '⏱️ En pausa corta...'; }

    barra.style.width = `${Math.min((currentTimer / CONFIG.PAUSA_TEMPORIZADOR) * 100, 100)}%`;
  }

  ctx.restore();
}


// ======================
// Cámara
// ======================
async function startCamera(){
  cameraInstance = new Camera(video,{
    onFrame: async()=>{ if(!paused) await hands.send({image:video}); },
    width:CONFIG.RES_W, height:CONFIG.RES_H, facingMode:'user'
  });
  await cameraInstance.start();

  video.addEventListener('loadeddata',()=>{
    canvas.width=CONFIG.RES_W;
    canvas.height=CONFIG.RES_H;
  });
}

startCamera();

// ======================
// Botones
// ======================
document.getElementById('btnCam').addEventListener('click', async ()=>{
  if(cameraOn){
    video.srcObject.getTracks().forEach(t=>t.stop());
    estado.textContent='📷 Cámara apagada';
    cameraOn=false;
  }else{
    await startCamera();
    estado.textContent='📸 Cámara encendida';
    cameraOn=true;
  }
});

document.getElementById('btnPause').addEventListener('click',()=>{
  paused=!paused;
  estado.textContent=paused?'⏸️ Pausado':'▶️ Reanudado';
});

document.getElementById('btnReset').addEventListener('click',()=>{
  lastDetected=false; currentTimer=0;
  barra.style.width='0%'; timerValue.textContent='0.0';
  estado.textContent='🔄 Reiniciado';
  bufferLetras=[]; ultimaLetra=null; chat.innerHTML='';
});

document.getElementById('btnStop').addEventListener('click',()=>{
  if(cameraInstance){ cameraInstance.stop(); estado.textContent='🛑 Reconocimiento terminado'; }
});
</script>

</body>
</html>
