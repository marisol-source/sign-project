{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Demo CÃ¡mara</title>
  <style>
    #video, #canvas {
      transform: scaleX(-1);
    }
  </style>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>
<body id="body" class="bg-gray-100 font-sans transition-colors duration-500">

  <!-- Navbar -->
  <nav class="fixed top-0 left-0 w-full bg-white shadow-md z-20">
    <div class="max-w-7xl mx-auto flex justify-between items-center py-2 px-6">
      <img src="{% static 'img/logotipo.png' %}" alt="Logo" class="w-36 h-auto">
      <ul class="hidden md:flex space-x-8 text-gray-900 font-semibold">
        <li><a href="{% url 'home' %}" class="hover:text-blue-600">Inicio</a></li>
        <li><a href="{% url 'demo' %}" class="hover:text-blue-600">Demo</a></li>
        <li><a href="{% url 'home' %}#nosotros" class="hover:text-blue-600">Nosotros</a></li>
      </ul>
      <button class="md:hidden text-gray-900 font-bold" id="menu-btn">â˜°</button>
    </div>
  </nav>

  <!-- SecciÃ³n CÃ¡mara -->
  <section id="demo" class="pt-32 pb-24 px-6 md:px-12 flex justify-center">
    <div class="w-full max-w-5xl bg-white p-6 rounded-2xl shadow-xl flex flex-col md:flex-row gap-6">

      <!-- CÃ¡mara -->
      <div class="flex flex-col items-center w-full md:w-1/2">
        <div class="flex justify-center gap-4 mb-4">
          <button id="btnPower" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition">
            ðŸ”´ Encender
          </button>
          <button id="btnModo" class="flex items-center gap-2 px-4 py-2 bg-gray-700 text-white rounded-lg shadow hover:bg-gray-800 transition">
            ðŸŒ™ Modo Noche
          </button>
        </div>

        <label for="selectorCamaras" class="text-gray-700 font-semibold mb-2">Dispositivo de video:</label>
        <select id="selectorCamaras" class="mb-6 w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"></select>

        <div class="w-full aspect-video bg-black rounded-lg overflow-hidden shadow mb-4 relative">
          <video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
          <canvas id="canvas" class="absolute top-0 left-0 w-full h-full"></canvas>
        </div>

        <div id="letterPreview" class="mt-2 text-5xl font-bold text-center text-blue-600 select-none">-</div>

        <div class="flex space-x-3">
          <button id="btnIniciar" class="px-5 py-2 bg-green-500 text-white rounded-lg shadow hover:bg-green-600 transition">Iniciar palabra</button>
          <button id="btnEspacio" class="px-5 py-2 bg-blue-500 text-white rounded-lg shadow hover:bg-blue-600 transition">Espacio</button>
          <button id="btnFinalizar" class="px-5 py-2 bg-red-500 text-white rounded-lg shadow hover:bg-red-600 transition">Finalizar</button>
        </div>
      </div>

      <!-- Chat -->
      <div class="flex flex-col w-full md:w-1/2">
        <h2 class="text-xl font-bold text-gray-700 mb-3">Texto generado</h2>
        <div id="chatBox" class="bg-gray-100 rounded-lg p-4 overflow-y-scroll h-[400px] shadow-inner"></div>
        <textarea id="finalText" readonly class="mt-4 w-full h-24 p-3 rounded-lg bg-gray-200 text-gray-800 resize-none" placeholder="AquÃ­ aparecerÃ¡ la oraciÃ³n completa..."></textarea>
      </div>

    </div>
  </section>

  <footer class="bg-gray-900 text-gray-200 py-12 px-6 md:px-12">
    <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-start gap-8">
      <div class="flex flex-col gap-6">
        <div class="flex gap-6 flex-wrap">
          <a href="#inicio" class="hover:text-white">Inicio</a>
          <a href="{% url 'demo' %}" class="hover:text-white">Demo</a>
          <a href="{% url 'home' %}#nosotros" class="hover:text-white">Nosotros</a>
          <a href="#" class="hover:text-white">Noticias</a>
          <a href="#" class="hover:text-white">Ayuda</a>
          <a href="#" class="hover:text-white">Contacto</a>
        </div>
        <p class="text-gray-400 text-sm">Â© 2025 Todos los derechos reservados</p>
      </div>
    </div>
  </footer>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const selectorCamaras = document.getElementById("selectorCamaras");
    const chatBox = document.getElementById("chatBox");
    const finalText = document.getElementById("finalText");
    const body = document.getElementById("body");
    const letterPreview = document.getElementById("letterPreview");

    const btnPower = document.getElementById("btnPower");
    const btnModo = document.getElementById("btnModo");
    const btnIniciar = document.getElementById("btnIniciar");
    const btnEspacio = document.getElementById("btnEspacio");
    const btnFinalizar = document.getElementById("btnFinalizar");

    let streamActual = null;
    let camHands = null;
    let modoOscuro = false;
    let frase = "";
    let reconocer = false;
    let ws = null;

    // ðŸ”¹ Variables para evitar repeticiÃ³n
    let lastLetter = null;
    let lastLetterTime = 0;
    const letterCooldown = 1000; // 1 segundo

    // Modo oscuro
    btnModo.addEventListener("click", () => {
      modoOscuro = !modoOscuro;
      if (modoOscuro) {
        body.classList.replace("bg-gray-100", "bg-gray-900");
        body.classList.add("text-white");
        btnModo.textContent = "â˜€ï¸ Modo DÃ­a";
      } else {
        body.classList.replace("bg-gray-900", "bg-gray-100");
        body.classList.remove("text-white");
        btnModo.textContent = "ðŸŒ™ Modo Noche";
      }
    });

    // Listar cÃ¡maras
    async function listarCamaras() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videoDevices = devices.filter(d => d.kind === "videoinput");
      selectorCamaras.innerHTML = "";
      videoDevices.forEach((device, index) => {
        const option = document.createElement("option");
        option.value = device.deviceId;
        option.text = device.label || `CÃ¡mara ${index + 1}`;
        selectorCamaras.appendChild(option);
      });
    }

    // Iniciar cÃ¡mara con MediaPipe
    async function iniciarHandsCam(deviceId) {
      if (streamActual) streamActual.getTracks().forEach(track => track.stop());
      streamActual = await navigator.mediaDevices.getUserMedia({ video: { deviceId: deviceId ? { exact: deviceId } : undefined } });
      video.srcObject = streamActual;
      await video.play();

      if (camHands) camHands.stop();

      const hands = new Hands({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
      });
      hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 0,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.5,
        smoothLandmarks: false
      });

      hands.onResults(async (results) => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (results.multiHandLandmarks) {
          drawConnectors(ctx, results.multiHandLandmarks[0], HAND_CONNECTIONS, { color: "#00FF00", lineWidth: 3 });
          drawLandmarks(ctx, results.multiHandLandmarks[0], { color: "#FF0000", lineWidth: 2, radius: 4 });

          if (reconocer) {
            const lm = results.multiHandLandmarks[0];
            const coords = [];
            for (let i = 0; i < 5; i++) coords.push(lm[i].x, lm[i].y);

            try {
              const resp = await fetch("http://127.0.0.1:8000/predecir", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ coords })
              });
              const data = await resp.json();
              const letra = data.prediccion || "-";

              const now = Date.now();
              if (letra !== lastLetter || (now - lastLetterTime) > letterCooldown) {
                lastLetter = letra;
                lastLetterTime = now;

                letterPreview.innerText = letra;
                frase += letra;
                chatBox.innerHTML += `<div>${letra}</div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
              }

            } catch (err) {
              console.error("Error al enviar coords al backend:", err);
            }
          }
        }
      });

      camHands = new Camera(video, { onFrame: async () => await hands.send({ image: video }), width: 640, height: 480 });
      camHands.start();

      btnPower.textContent = "Apagar";
      btnPower.classList.replace("bg-green-600", "bg-red-600");
    }

    function apagarCamara() {
      if (!streamActual) return;
      streamActual.getTracks().forEach(track => track.stop());
      video.srcObject = null;
      streamActual = null;
      if (camHands) camHands.stop();
      btnPower.textContent = "Encender";
      btnPower.classList.replace("bg-red-600", "bg-green-600");
    }

    selectorCamaras.addEventListener("change", e => iniciarHandsCam(e.target.value));
    btnPower.addEventListener("click", () => streamActual ? apagarCamara() : iniciarHandsCam(selectorCamaras.value));

    btnIniciar.addEventListener("click", () => {
      frase = "";
      lastLetter = null;
      lastLetterTime = 0;
      chatBox.innerHTML += `<div>> Iniciando palabra...</div>`;
      chatBox.scrollTop = chatBox.scrollHeight;
      reconocer = true;
    });

    btnEspacio.addEventListener("click", () => {
      frase += " ";
      chatBox.innerHTML += `<div>> (espacio)</div>`;
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    btnFinalizar.addEventListener("click", () => {
      finalText.value = frase.trim();
      chatBox.innerHTML += `<div>--- palabra finalizada ---</div>`;
      chatBox.scrollTop = chatBox.scrollHeight;

      // Reset
      frase = "";
      lastLetter = null;
      lastLetterTime = 0;
      letterPreview.innerText = "-";
      reconocer = false;

      
      // Reiniciar reconocimiento despuÃ©s de un pequeÃ±o delay
      setTimeout(() => { 
        reconocer = true; 
        chatBox.innerHTML += `<div>> Iniciando nueva palabra...</div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
      }, 500);
    });

    // WebSocket
    function iniciarWebSocket() {
      try { if (ws && ws.readyState === WebSocket.OPEN) ws.close(); } catch(e) {}

      ws = new WebSocket("ws://127.0.0.1:8000/ws");

      ws.onopen = () => console.log("Conectado al WebSocket âœ…");
      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data || "{}");
          const letra = data.letter || "";
          const palabra = data.word || "";

          if (palabra) {
            letterPreview.innerText = palabra;
          } else if (letra) {
            letterPreview.innerText = letra;
            if (window._clearLetterPreviewTimeout) clearTimeout(window._clearLetterPreviewTimeout);
            window._clearLetterPreviewTimeout = setTimeout(() => { letterPreview.innerText = "-"; }, 1200);

            frase += letra;
            chatBox.innerHTML += `<div>${letra}</div>`;
            chatBox.scrollTop = chatBox.scrollHeight;
          } else {
            letterPreview.innerText = "-";
          }
        } catch (err) {
          console.error("Error procesando mensaje WS:", err, event.data);
        }
      };

      ws.onerror = (err) => console.error("WebSocket error:", err);
      ws.onclose = (ev) => {
        console.warn("WebSocket cerrado", ev.code, ev.reason || "");
        letterPreview.innerText = "-";
        setTimeout(() => { if (reconocer) iniciarWebSocket(); }, 1000);
      };
    }

    window.addEventListener("load", async () => {
      await listarCamaras();
      if (selectorCamaras.options.length > 0) iniciarHandsCam(selectorCamaras.value);
      iniciarWebSocket();
    });
  </script>

</body>
</html>


