<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prueba MediaPipe Hands</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>
<body id="body" class="bg-gray-100 font-sans transition-colors duration-500">

  <div class="p-6 max-w-3xl mx-auto flex flex-col gap-4">
    <h1 class="text-2xl font-bold text-gray-700 mb-4">Prueba MediaPipe Hands</h1>

    <!-- Botones -->
    <div class="flex gap-3">
      <button id="btnPower" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Encender</button>
      <button id="btnModo" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800">üåô Modo Noche</button>
    </div>

    <!-- Selector de c√°maras -->
    <div class="flex flex-col mt-3">
      <label for="selectorCamaras" class="font-semibold text-gray-700 mb-1">C√°mara:</label>
      <select id="selectorCamaras" class="p-2 border rounded-lg"></select>
    </div>

    <!-- Video y Canvas -->
    <div class="relative mt-4 w-full h-96 bg-black rounded-lg overflow-hidden shadow">
      <video id="video" autoplay playsinline class="absolute top-0 left-0 w-full h-full object-cover"></video>
      <canvas id="canvas" class="absolute top-0 left-0 w-full h-full"></canvas>
    </div>

    <!-- Chat simulado -->
    <div class="mt-4 flex flex-col gap-2">
      <h2 class="font-bold text-gray-700">Chat:</h2>
      <div id="chatBox" class="bg-gray-100 p-4 rounded-lg h-48 overflow-y-auto"></div>
      <textarea id="finalText" readonly class="mt-2 w-full h-24 p-2 rounded-lg bg-gray-200 resize-none" placeholder="Aqu√≠ aparecer√° la oraci√≥n completa..."></textarea>
    </div>

    <!-- Botones de prueba -->
    <div class="flex gap-3 mt-2">
      <button id="btnIniciar" class="px-4 py-2 bg-green-500 text-white rounded-lg">Iniciar palabra</button>
      <button id="btnEspacio" class="px-4 py-2 bg-blue-500 text-white rounded-lg">Espacio</button>
      <button id="btnFinalizar" class="px-4 py-2 bg-red-500 text-white rounded-lg">Finalizar</button>
    </div>
  </div>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const selectorCamaras = document.getElementById("selectorCamaras");
    const chatBox = document.getElementById("chatBox");
    const finalText = document.getElementById("finalText");
    const body = document.getElementById("body");

    const btnPower = document.getElementById("btnPower");
    const btnModo = document.getElementById("btnModo");
    const btnIniciar = document.getElementById("btnIniciar");
    const btnEspacio = document.getElementById("btnEspacio");
    const btnFinalizar = document.getElementById("btnFinalizar");

    let streamActual = null;
    let camHands = null;
    let modoOscuro = false;
    let frase = "";

    // Modo oscuro
    btnModo.addEventListener("click", () => {
      modoOscuro = !modoOscuro;
      if (modoOscuro) {
        body.classList.replace("bg-gray-100", "bg-gray-900");
        body.classList.add("text-white");
        btnModo.textContent = "‚òÄÔ∏è Modo D√≠a";
      } else {
        body.classList.replace("bg-gray-900", "bg-gray-100");
        body.classList.remove("text-white");
        btnModo.textContent = "üåô Modo Noche";
      }
    });

    // Listar c√°maras
    async function listarCamaras() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videoDevices = devices.filter(d => d.kind === "videoinput");

      selectorCamaras.innerHTML = "";
      videoDevices.forEach((device, index) => {
        const option = document.createElement("option");
        option.value = device.deviceId;
        option.text = device.label || `C√°mara ${index + 1}`;
        selectorCamaras.appendChild(option);
      });
    }

    // Iniciar c√°mara con MediaPipe
    async function iniciarHandsCam(deviceId) {
      if (streamActual) {
        streamActual.getTracks().forEach(track => track.stop());
      }

      streamActual = await navigator.mediaDevices.getUserMedia({
        video: { deviceId: deviceId ? { exact: deviceId } : undefined }
      });
      video.srcObject = streamActual;
      await video.play();

      if (camHands) camHands.stop();

      // MediaPipe Hands
      const hands = new Hands({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
      });

      hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.5
      });

      hands.onResults((results) => {
        // Limpiar canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Ajustar canvas al tama√±o del video
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        // Dibujar landmarks
        if (results.multiHandLandmarks) {
          for (const landmarks of results.multiHandLandmarks) {
            drawConnectors(ctx, landmarks, HAND_CONNECTIONS, { color: "#00FF00", lineWidth: 3 });
            drawLandmarks(ctx, landmarks, { color: "#FF0000", lineWidth: 2, radius: 4 });

            // Simular letra en el chat
            chatBox.innerHTML += `<div class="mb-1">üñê Mano detectada</div>`;
            chatBox.scrollTop = chatBox.scrollHeight;
          }
        }
      });

      camHands = new Camera(video, {
        onFrame: async () => await hands.send({ image: video }),
        width: 640,
        height: 480
      });
      camHands.start();

      btnPower.textContent = "Apagar";
      btnPower.classList.replace("bg-green-600", "bg-red-600");
    }

    // Apagar c√°mara
    function apagarCamara() {
      if (!streamActual) return;
      streamActual.getTracks().forEach(track => track.stop());
      video.srcObject = null;
      streamActual = null;
      if (camHands) camHands.stop();
      btnPower.textContent = "Encender";
      btnPower.classList.replace("bg-red-600", "bg-green-600");
    }

    // Cambiar c√°mara
    selectorCamaras.addEventListener("change", e => iniciarHandsCam(e.target.value));

    // Bot√≥n encender/apagar
    btnPower.addEventListener("click", () => streamActual ? apagarCamara() : iniciarHandsCam(selectorCamaras.value));

    // Chat simulado
    btnIniciar.addEventListener("click", () => {
      chatBox.innerHTML += `<div>> Iniciando palabra...</div>`;
      frase = "";
    });

    btnEspacio.addEventListener("click", () => {
      chatBox.innerHTML += `<div>> (espacio)</div>`;
      frase += " ";
      chatBox.scrollTop = chatBox.scrollHeight;
    });

    btnFinalizar.addEventListener("click", () => {
      finalText.value = frase.trim();
      chatBox.innerHTML += `<div>--- palabra finalizada ---</div>`;
      chatBox.scrollTop = chatBox.scrollHeight;
      frase = "";
    });

    // Inicializar
    window.addEventListener("load", async () => {
      await listarCamaras();
      if (selectorCamaras.options.length > 0) {
        iniciarHandsCam(selectorCamaras.value);
      }
    });
  </script>
</body>
</html>
